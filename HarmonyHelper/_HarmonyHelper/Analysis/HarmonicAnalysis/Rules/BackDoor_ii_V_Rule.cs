using Eric.Morrison.Harmony.Chords;
using Eric.Morrison.Harmony.HarmonicAnalysis;
using Eric.Morrison.Harmony.HarmonicAnalysis.Rules;
using Eric.Morrison.Harmony.Intervals;

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Eric.Morrison.Harmony.Analysis.HarmonicAnalysis.Rules
{
#if false
THE BACKDOOR II-V PROGRESSION
BY ANTON SCHWARTZ
If you play jazz music, you know how a standard ii-V-I progression works: a Dm7 chord followed by a G7 chord resolves to a C chord. We also hear a lot about the Tritone Substitution ii-V, in which the Dm7 and G7 resolve, instead, to the key of F. Well, there is another very common resolution of the ii-V progression, sometimes called the “Backdoor ii-V” or “Backdoor Turnaround” or “Backdoor Progression.” It is much more common among standards than the tritone sub version, but it gets surprisingly little discussion relative to the others. In it, the Dm and G7 resolve to the key of A. In other words, a iv7 chord leads to the VII7 chord, which resolves to the I chord. A good example of its use is in bars 3-5 of the Tadd Dameron standard, Lady Bird. Another is bars 4-5 of Misty.

I thought about it for awhile one night and here are some jazz standards I came up with that use it:

Blue Daniel
Dolphin Dance
For All We Know
Groovin’ High
Half Nelson (Lady Bird)
How Deep is the Ocean
I Could Write a Book
I Didn’t Know What Time It Was
I Should Care
I Want to Talk About You
I’ll Be Seeing You
Just Friends
Morning Dance
My Foolish Heart
My Old Flame
Misty
A Nightingale Sang in Berkeley Square
Nobody Else But Me
Nostalgia In Times Square
One For My Baby
Round Midnight
Silver’s Serenade
Somewhere Over the Rainbow
Soultrane
Stardust
Stella By Starlight
Sweet & Lovely
Tea for Two
Till There Was You
Tenderly
When in Rome
When Sonny Gets Blue
Yardbird Suite
Plus a couple of pop songs:

In My Life (Beatles)
Just The Way You Are (Billy Joel)
You Are So Beautiful (Billy Preston)
As an exercise, see if you can find the backdoor turnaround in each of the songs. Play them—either a recorded version or on your instrument. Once you get a feeling for what it sounds like, you’ll come to identify the progression easily.

Variations
There are a couple common variants to the backdoor progression. In these songs it appears as IV – VII7 – I (i.e. with a major four chord instead of minor):

Águas de Março (Waters of March)
Cherokee
Come Fly With Me
Donna Lee (Back Home Again in Indiana)
Happier Than The Morning Sun (Stevie Wonder)
Hello Goodbye (Beatles)
Higher Ground (Stevie Wonder)
How Long Has This Been Going On
I Thought About You
I Want a Little Girl
Layla (Eric Clapton)
Long Ago & Far Away
My Romance
Stella By Starlight
That’s the Way of the World
There Will Never Be Another You
The Feeling of Jazz
We Are Family (Sister Sledge)
And in these, the turnaround resolves not to the I but to the very closely related iii chord:

All The Things You Are
Beatrice
Body & Soul
Darn That Dream
Days of Wine & Roses
Don’t Blame Me
Ev’ry Time We Say Goodbye
Four
Girl from Ipanema
How High The Moon / Ornithology
I Fall In Love Too Easily
Ill Wind
Joy Spring
Line for Lyons
Meditation
My Shining Hour
On a Clear Day
The Best Thing for You
This Time the Dream’s on Me
Once again, see if you can identify the backdoor progression in each song.

WHY DOES THE BACKDOOR PROGRESSION WORK?
There are many ways of looking at the backdoor progression, but here are a few. For simplicity, let’s talk in the key of C, making the progression
Fm7 | B7 | C:

First, the B7 chord of the backdoor progression is very closely related to the G7 and D7 chords of the normal and tritone-sub ii-V progressions. If we voice each of the three chords with with a 9 and 13, they all use the same B diminished chord and whole-half diminished scale. And we may see the chordtones of the B7 as the 9 (B), 5 (D), 7 (F) and 9 (A) of G dominant.
The Fm7 chord of the backdoor progression functions much like the Dø7 chord, which leads to C in a minor ii-V progression. The Dø7 chord is effectively the relative minor of the Fm7 chord, since it is based a minor third down from the Fm7 and the 1-3-5 of the Fm7 are the 3-5-7 of Dø7. Differently put, an Fm6 chord is merely an inversion of a Dø7.
The backdoor progression leading to a major key is the tritone sub progression of the closely-related relative minor. Since Fm7–B7 leads easily to Am, it should be no surprise that it also leads to Am’s relative major, C.
An audio comparison
As part of my post entitled “Jazz Harmony — You Have the Answers” I take a look at Tadd Dameron’s Lady Bird and imagine, with audio, what it might have sounded like had he used a standard ii-V in bars 3-4 instead of a backdoor. You may find the comparison an interesting listen in light of this post.

IMPROVISING OVER THE BACKDOOR PROGRESSION
Normal ii-V-I progressions have a flow to them. Constructing a great phrase over a ii-V-I is not the same as being able to play modally over each of the 3 chords individually. So too, backdoor progressions have a flow that needs to be respected. Luckily, if you have melodic ideas you like that work well over standard ii-V’s, it’s pretty easy to make them work over a backdoor. Here’s a sheet of some examples which I’ll refer to below.

Reduce, Reuse, Recycle
The first two bars of a backdoor are much the same as a normal iim7-V7… just transposed up a minor third to become  ivm7-VII7). So we can start by transposing our ii-V-I phrase up a minor third. Sometimes that is all we need (e.g. example 2). But in general, when we transpose up a minor third, our ii-V-I will resolve to III instead of I, so the final note may need changing.

Avoid Dark Dominants
The altered dominant sound resolves very powerfully down a fifth, but does not tend to resolve up a step. For that reason, it is a poor choice to use for the dominant chord in a backdoor progression. In general, a dark dominant chord which contains a ♯9 or (especially) a 13 should be brightened if it is to be used in a backdoor progression. This is what we do in examples 4, 5 and 6, substituting the bright 9, p5 and 13 (from out of the bright Lydian Dominant scale) for the dark notes.

A Bluesy Approach
The backdoor progression lends itself very well to a blues-based sound, which requires a very different approach to constructing phrases.

Key to appropriating the blues over chord progressions are these principles:

Always use a scale relative to the tonic, not to each passing chord.
The primary tools are major & minor pentatonic scales and their respective blues scales…
major blues scale = major pentatonic + the minor 3rd
minor blues scale = minor pentatonic + the flat 5 *
* We say “minor blues scale” for clarity, but it’s usually called just the “blues scale”
Pick your scales to match the overall sound of the chords.
With that in mind, observe that:

The major pentatonic scale fits perfectly over the final I chord. Say, for instance we’re in C; then we can use C major pentatonic.
The notes of the minor pentatonic scale all fit within the scales for iv7 and VII7.
If we’re in C we can use F Dorian for Fm7 and B Mixolydian for B7, and those are each the same notes as the E major scale. Since C minor pentatonic is the same notes as the E major pentatonic, it fits within E major, so it fits perfectly over the two chords.
So our recipe is simple and powerful:
Think in the tonic (I) key and play minor-bluesy over the first two chords and major-bluesy when you resolve.

Note that this approach misses out on some important notes. The C blues scale doesn’t include the A that is the 3rd of Fm7 and the 7th of B7. This would be a concern if we were playing swing or bebop, but not in the blues idiom; the C blues scale hits the tonal center of the Fm7 and B7 chords, and that’s all that’s important.

Epilogue
None of the song lists above are comprehensive – I’m sure there are lots of good examples I didn’t think of. Can you think of some? Leave a comment!

Thank you to the people who have made suggestions below that I’ve added to the list! Steve, Duffy, Kostas, Geoff and Aaron – much obliged!

Further Reading
In another blog post I discuss a different progression in which a ii-V sequence resolves upward not a whole step up but a half step. Check it out here if you like: A Nameless ii-V Cadence.
#endif

    /// <summary>
    /// https://antonjazz.com/2012/01/backdoor-ii-v-progression/
    /// </summary>
    public class BackDoor_ii_V_Rule : HarmonicAnalysisRuleBase
    {
        public override string Name => "Backdoor ii-V";

        public override string Description => throw new NotImplementedException();


        public override List<HarmonicAnalysisResult> Analyze(List<ChordFormula> chords)
        {
            var result = new List<HarmonicAnalysisResult>();

            var triplets = chords.GetItems(3);
            foreach (var triplet in triplets)
            {//Minor: bm7b5, e7 Major: bm7 e7
                if (triplet.Take(2).IsTwoFive(out var key))
                {
                    if (triplet[2].Root - triplet[1].Root == Interval.Major2nd)
                    {
                        var backdoorKey = KeySignature.InternalCatalog
                            .Where(x => x.NoteName == triplet[2].Root
                                && x.IsMinor == key.IsMinor)
                            .First();
                        var item = CreateHarmonicAnalysisResult(triplet, backdoorKey);
                        result.Add(item);
                    }
                }
            }
            return result;
        }

        HarmonicAnalysisResult CreateHarmonicAnalysisResult(IEnumerable<ChordFormula> chords, KeySignature key)
        {
            var one = key.IsMinor ? "i" : "I";
            var msg = $"{string.Join(", ", chords.Select(x => x.Name))} is a Backdoor ii, V, {one} in {key.Name}.";
            var result = new HarmonicAnalysisResult(this, true, msg,
                chords.ToList());
            return result;
        }
    }
}
